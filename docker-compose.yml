services:
  api-server:
    build:
      context: .
      dockerfile: settings/api-server/Dockerfile
    ports:
      - "8080:8080"
    environment:
      SERVER_ADDR: 0.0.0.0
    secrets:
      - mysql_user
      - mysql_password
    depends_on:
      - db

  db:
    image: mysql:8.4.7
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql-root-password
      MYSQL_USER_FILE: /run/secrets/mysql-user
      MYSQL_PASSWORD_FILE: /run/secrets/mysql-password
    volumes:
      - ./settings/mysql/secrets:/run/secrets
      - ./settings/mysql/init:/docker-entrypoint-initdb.d
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"

secrets:
  mysql_user:
    file: ./settings/mysql/secrets/mysql-user
  mysql_password:
    file: ./settings/mysql/secrets/mysql-password

volumes:
  mysql-data:
